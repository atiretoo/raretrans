---
title: "Simulation Studies"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Simulation Studies}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
options(huxtable.add_colnames = FALSE,
        digits = 3)
```

```{r setup}
library(raretrans)
library(tidyverse)
library(popbio)
library(huxtable)

# Raymond's theme modifications
rlt_theme <- theme(axis.title.y = element_text(colour="grey20",size=15,face="bold"),
        axis.text.x = element_text(colour="grey20",size=15, face="bold"),
        axis.text.y = element_text(colour="grey20",size=15,face="bold"),  
        axis.title.x = element_text(colour="grey20",size=15,face="bold"))
```

Reviewers have asked for a simulation study to confirm that the approach works. 
We will start with two different "true" matrices, simulate observed data from
these, and then use different priors to evaluate how the method works. 

# Calathea, an understory herb

The first example comes from `popbio::calathea` containing matrices publised in
Horvitz and Schemske (1995). There are 4 plots and up to 5 years of transitions,
as well as a pooled matrix. Many of the transitions are very small probabilities.


```{r}
calathea$pooled
```

We begin by simulating a data frame with N observations of plants. 
The initial population will be sampled from the stable stage distribution.
The function `raretrans::sim_transition` doesn't quite do what we 
want because it returns matrices, and we want the underlying observations.
Maybe that's what sim_transition should do, but it doesn't.

```{r}
TF <- splitA(calathea$pooled, r = 1, c = 3:8)
df <- sim_observations(TF)
tail(df) # more interesting
```

```{r}
projection_matrix(df, stage = "stage", fate = "fate", fertility = "fertility")
```
OK, so seems to work with the modified `projection_matrix`. Now we
generate a number of samples to work with, calculating some 
matrix statistics along the way.

```{r, warning=FALSE}
results <- tibble(observations = map(1:100, function(x)sim_observations(TF, N = 100)),
       TF = map(observations, projection_matrix, fertility = "fertility", TF = TRUE),
       N = map(observations, get_state_vector),
       Tunif = map2(TF, N, fill_transitions),
       Funif = map2(TF, N, fill_fertility),
       A = map(TF, ~.x$T+.x$F),
       Aunif = map2(Tunif, Funif, ~.x + .y)) %>% 
  mutate(lambdaraw = map_dbl(A, lambda),
         lambdaunif = map_dbl(Aunif, lambda))
ggplot(data = results) + 
  geom_point(mapping = aes(x = lambdaraw, y = lambdaunif)) + 
  geom_hline(yintercept = lambda(TF$T + TF$F))
```
The uniform prior clearly causes issues by creating values of 1 in the fertility 
matrix for all stages that are not represented in the sample. 

Now we need to create some priors for this plant. Start with samples of size 1
for transitions known to be possible. Fertility priors will be 0 except 
for stages known to reproduce, and these will be set close to zero.

```{r}
transition_prior <- rbind(TF$T > 0, rep(1, times = ncol(TF$T)))
column_sums <- apply(transition_prior, 2, sum)
transition_prior <- sweep(transition_prior, 2, column_sums, `/` )
fertility_alpha <- TF$F * 0
fertility_alpha[1, 3:8] <- 1e-5
fertility_beta <- TF$F * 0 + (1-1e-5) # to keep sum = 1 
results <- tibble(observations = map(1:100, function(x)sim_observations(TF, N = 100)),
       TF = map(observations, projection_matrix, fertility = "fertility", TF = TRUE),
       N = map(observations, get_state_vector),
       Tunif = map2(TF, N, fill_transitions, P = transition_prior),
       Funif = map2(TF, N, fill_fertility, alpha = fertility_alpha, beta = fertility_beta),
       A = map(TF, ~.x$T+.x$F),
       Aunif = map2(Tunif, Funif, ~.x + .y)) %>% 
  mutate(lambdaraw = map_dbl(A, lambda),
         lambdaunif = map_dbl(Aunif, lambda))
ggplot(data = results) + 
  geom_point(mapping = aes(x = lambdaraw, y = lambdaunif)) + 
  geom_hline(yintercept = lambda(TF$T + TF$F))
```

Let's take a look at the matrix that results in the largest posterior lambda.

```{r}
pick <- which.max(results$lambdaunif)
results$Tunif[[pick]]
results$Funif[[pick]]
```


# Literature cited

Horvitz, C.C. and D.W. Schemske. 1995. Spatiotemporal variation in demographic transitions of a tropical understory herb: Projection matrix analysis. Ecological Monographs 65:155-192.
