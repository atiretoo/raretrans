---
title: "Working with a single population and transition"
output:
  rmarkdown::html_vignette:
    fig_caption: yes
vignette: >
  %\VignetteIndexEntry{Working with a single population and transition period}
  \VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
---

```{r setup, message = FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(popbio)
library(popdemo)
library(raretrans)
# Raymond's theme modifications
rlt_theme <- theme(axis.title.y = element_text(colour="grey20",size=15,face="bold"),
        axis.text.x = element_text(colour="grey20",size=15, face="bold"),
        axis.text.y = element_text(colour="grey20",size=15,face="bold"),  
        axis.title.x = element_text(colour="grey20",size=15,face="bold"))

```

We want to be able to use this package with single populations and transitions. Regardless of how many populations there are, we need the data in the form expected by `popbio::projection_matrix` to get the matrices we want. Here we demonstrate how the package works with a single population in the desired format, by extracting the transition and fertility data for *L. elto* POPNUM 250 in period 5.

```{r}
data("L_elto")
onepop <- filter(L_elto, POPNUM == 250, year == 5) %>% 
  mutate(stage = case_when(stage == "p" ~ "s",
                           TRUE ~ stage),
         next_stage = case_when(next_stage == "p"~ "s",
                                TRUE ~ next_stage))
#popbio::projection.matrix doesn't like tibbles
TF <- projection.matrix(as.data.frame(onepop), 
                        stage = stage, fate = next_stage, 
                        fertility="fertility", sort=c("s","j","a"), TF = TRUE)
TF
```

Now we also need the number of individuals in each stage at the start. This is because our priors are based on counts, and the prior equivalent sample size is expressed as a multiple of the number of individuals observed. We have a function `raretrans::get_state_vector()` to do this.

```{r}
N <- get_state_vector(onepop, stage = stage, sort=c("s","j","a"))
N
```

The rare transition that is missing from this matrix is the seedling to adult, which in the RLT prior happens ~ 1% of the time. The observed asymptotic population growth rate is $\lambda =$ `r format(lambda(TF$T + TF$F),digits = 2)`.

First, use the default uniform prior on transitions and uninformative gamma on fecundity. We have to specify the parameters for the fecundity prior on non-reproducing stages as missing, or the result will fill in the entire matrix. The default for both functions returns the full matrix **A**, so we have to tell the function to only return the transition and fecundity matrices. 

```{r}
unif <- list(T = fill_transitions(TF, N, returnType = "T"), 
             F = fill_fecundity(TF, N, 
                                alpha = c(NA_real_, NA_real_, 1e-05),
                                beta = c(NA_real_, NA_real_, 1e-05),
                                returnType = "F"))
unif
```

And the asymptotic population growth rate is $\lambda =$ `r format(lambda(unif$T + unif$F),digits = 2)`. The growth rate shrinks slightly because applying the uniform prior on transition probabilities causes observed growth and survival transitions to shrink slightly relative to those that are unobserved. 

There are two other returnTypes. `fill_transitions()` can return an augmented matrix of fates which is useful for simulation.

```{r}
fill_transitions(TF, N, returnType = "TN")
```

The fourth row of this result is the mortality state. `fill_fecundity()` can return the alpha and beta vectors of the posterior.

```{r}
fill_fecundity(TF, N, 
               alpha = c(NA_real_, NA_real_, 1e-05),
               beta = c(NA_real_, NA_real_, 1e-05),
               returnType = "ab")
```

This demonstrates why the posterior point estimate of fecundity does not change much; the non-informative values for $\alpha$ and $\beta$ barely change the observed values. 

# Informative Priors

We can skip using `popbio::projection.matrix()` if the matrix is already calculated, as long as we also have the stage vector. We use population 231 in period 2 as an example, splitting the matrix into transition T and fecundity F matrices.

```{r, echo=FALSE}
# Matrix
Tmat <- L_elto %>% 
  mutate(stage = factor(stage, levels=c("p","j","a","m")),
         fate = factor(next_stage, levels=c("p","j","a","m"))) %>%
  filter(POPNUM == 231, year == 2) %>%
  as.data.frame() %>% 
  xtabs(~fate + stage, data = .) %>% 
  as.matrix()
Tmat <- Tmat[,-4]
N <- colSums(Tmat)
Tmat <- sweep(Tmat[-4,], 2, N, "/")
# L_elto %>% 
#   mutate(stage = factor(stage, levels=c("p","j","a","m")),
#          fate = factor(next_stage, levels=c("p","j","a","m"))) %>%
#   filter(POPNUM == 231, year == 3, stage == "p") %>%
#   count(stage) 
# 2 offspring from N[3] == 16 adults
Fmat <- matrix(0, nrow=3, ncol=3)
Fmat[1,3] <- 2/16
(TF <- list(Tmat = Tmat, Fmat = Fmat))

```

There were `r paste(N, collapse=", ")` seedlings, juveniles, and adults, respectively, at the start of period 2.
This matrix is missing the rare transition from seedling to juvenile, and no juveniles died leading to an overestimate of
survival. So, to add a uniform dirichlet prior with a weight of 1 to $T$, we have 4 fates (3 + death), so each fate adds 0.25 to the matrix of *observed* fates (not the transition matrix!). When we specify a prior matrix for the transitions, there is one more row than columns. This extra row
represents death.

```{r}
Tprior <- matrix(0.25, byrow = TRUE, ncol = 3, nrow=4)
fill_transitions(TF, N, P = Tprior) # returns transition matrix by default
```

You can get the same result 'by hand'

```{r}
Tobs <- sweep(TF$Tmat,2,N,"*") # get the observed transitions
Tobs <- rbind(Tobs, N - colSums(Tobs)) # add the mortality row
Tobs <- Tobs + 0.25 # add the prior
sweep(Tobs, 2, colSums(Tobs), "/")[-4,] # divide by the column sum, and discard mortality
```

The uniform prior creates problems by filling in finite values for transitions that are 
impossible, such as adult->seedling (should only be in fecundity matrix). To fix this problem we specify a more informative prior. It still has to have the same shape, one more row 
than columns.

```{r}
RLT_Tprior <- matrix(c(0.25, 0.025, 0.0,
                       0.05, 0.9,   0.025,
                       0.01, 0.025, 0.95,
                       0.69, 0.05,  0.025), 
                     byrow = TRUE, nrow = 4, ncol = 3)
```

This prior is constructed so the columns sum to 1, which creates the greatest flexibility 
for weighting the prior.
 
```{r}
fill_transitions(TF, N, P = RLT_Tprior)
```

We can specify the weight as a multiple of the sample size for each stage.

```{r}
fill_transitions(TF, N, P = RLT_Tprior, priorweight = 0.5)
```

Here the prior is weighted half as much as the observed number of transitions, which is 
larger than 1 but still allows the data to dominate. 

# Getting Credible Intervals on individual matrix entries

The marginal posterior distribution of one element in a multinomial is a beta distribution, and
we use this to get credible intervals on our transition rates. We can use the 
TN return type to get the parameters of the desired multinomial.

```{r}
TN <- fill_transitions(TF, N, P = RLT_Tprior, priorweight = 0.5, returnType = "TN")
alpha <- TN[,1]
beta <- sum(TN[,1]) - TN[,1]
p <- alpha / (alpha + beta)
lcl <- qbeta(0.025, alpha, beta)
ucl <- qbeta(0.975, alpha, beta)
sprintf("%.2f (%.2f, %.2f)", p, lcl, ucl)
```

Those are the point estimates (compare with first column above), lower and upper 95% credible 
intervals for transitions
out of the seedling stage. There is a high degree of uncertainty because of the small sample size (2), 
and low weight on the prior (1), leading to an effective sample size of 3. If we up the effective sample 
size to 20 by setting priorweight = 9 (9*2 = 18 + 2 = 20)

```{r}
TN <- fill_transitions(TF, N, P = RLT_Tprior, priorweight = 9, returnType = "TN")
alpha <- TN[,1]
beta <- sum(TN[,1]) - TN[,1] # beta parameter is sum of all other dirichlet parameters.
p <- alpha / (alpha + beta)
lcl <- qbeta(0.025, alpha, beta)
ucl <- qbeta(0.975, alpha, beta)
sprintf("%.2f (%.2f, %.2f)", p, lcl, ucl)
```

the credible intervals shrink quite a bit. 

# Credible intervals on $\lambda$

Obtaining credible intervals on the asymptotic growth rate, $\lambda$, requires simulating matrices 
from the posterior distributions. This is somewhat complicated to do correctly, and we have written 
a function `sim_transitions()` to generate a list of simulated matrices given the observed matrix and
prior specifications.

```{r}
sim_transitions(TF, N, P = RLT_Tprior, alpha = c(NA, NA, 0.025), beta = c(NA, NA, 1),
                priorweight = 0.5)
```

Now we simulate 1000 times, calculate the leading eigenvalue of each matrix, and draw a histogram.

```{r}
set.seed(8390278) # make this part reproducible
RLT_0.5 <- sim_transitions(TF, N, P = RLT_Tprior, alpha = c(NA, NA, 0.025), beta = c(NA, NA, 1),
                priorweight = 0.5, samples = 1000)
RLT_0.5 <- tibble(lposterior = map_dbl(RLT_0.5, lambda))

ggplot(data = RLT_0.5,
       mapping = aes(x = lposterior)) + 
  geom_histogram(binwidth = 0.02)
```

We can calculate some summary statistics too.
```{r}
RLT_0.5_summary <- summarize(RLT_0.5,
                             medianL = median(lposterior),
                             meanL = mean(lposterior),
                             lcl = quantile(lposterior, probs = 0.025),
                             ucl = quantile(lposterior, probs = 0.975),
                             pincrease = sum(lposterior > 1.)/n())
knitr::kable(RLT_0.5_summary, digits = 2)
```

