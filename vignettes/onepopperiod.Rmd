---
title: "Working with a single population and transition"
output:
  rmarkdown::html_vignette:
    fig_caption: yes
vignette: >
  %\VignetteIndexEntry{Working with a single population and transition period}
  \VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
---

```{r setup, message = FALSE}
knitr::opts_chunk$set(echo = TRUE, tidy = TRUE)
library(tidyverse)
library(popbio)
library(popdemo)
library(raretrans)
# Raymond's theme modifications
rlt_theme <- theme(axis.title.y = element_text(colour="grey20",size=15,face="bold"),
        axis.text.x = element_text(colour="grey20",size=15, face="bold"),
        axis.text.y = element_text(colour="grey20",size=15,face="bold"),  
        axis.title.x = element_text(colour="grey20",size=15,face="bold"))

```
# Part I: Obtaining the projection matrix from `popbio::projection_matrix`

The goal of this vignette is to demonstrate the use of package `raretrans`, which requires correct data formatting for input into `popbio::projection_matrix`. Although  `raretrans` can handle multiple populations, here we use only a single population as an example. Obtaining the correct data formatting of the data for `popbio::projection_matrix` requires us to extract the transition and fertility data for *L. elto* **POPNUM 250** in **period 5**. We demonstrate this below. 

## Step 1: Load and munge the single population data for *L. elto*

```{r mungeData}
data("L_elto") # load the dataset `L_elto` into memory (from package `raretrans`)
head(L_elto)# ???Perhaps preview the L_elto dataset..???

onepop <- L_elto %>%   
# Filter out population # 250, period (year) 5
  filter(POPNUM == 250, year == 5) %>% 
  # Define stages (state why we are cahnging p --> s here)
  mutate(stage = case_when(stage == "p" ~ "s",
                           TRUE ~ stage),
         next_stage = case_when(next_stage == "p"~ "s",
                                TRUE ~ next_stage))


# popbio::projection.matrix doesn't like tibbles
TF <- popbio::projection.matrix(as.data.frame(onepop), 
                        stage = stage, fate = next_stage, 
                        fertility="fertility", sort=c("s","j","a"), TF = TRUE)
TF # This is the stage-structured population model
```

Our stages are now coded as **s** (seedling), **j** (juvenile), and **a** (adult), and we now have two matrices: **T** (stage transition) and **F** (fecundity).


## Step 2: Obtain starting number of individuals per stage
Since our priors are based on counts (number of individuals, *N*) and the prior equivalent sampling size is expressed as a multiple of the number of individuals observed, we need to obtain the  number of individuals in each stage ($N$) at the first time period.

We use function `raretrans::get_state_vector()` to obtain the starting individual count, *N*.

```{r}
N <- get_state_vector(onepop, stage = stage, sort=c("s","j","a")) 
N # A vector of # of starting individuals for each stage
```

## Step 3: Incorporate rare transitions 
The rare transition that is missing from our transition(?) matrix, `T`, is the transition from seedling (*s*) to adult (*a*). In the RLT (DEFINE THIS?) prior, this transitions happens ~ 1% of the time. Therefore, the observed asymptotic population growth rate is $\lambda =$ `r format(lambda(TF$T + TF$F),digits = 2)`.

(JLB -- I don't understand par 69):
First, we use a default uniform prior on the transition (**T**), and an uninformative gamma prior on fecundity **F**. We must specify the parameters for the fecundity prior on the non-reproducing stages as **missing**, else the result will fill in the entire matrix. The default for both functions (`fill_transitions` and `fill_fecundity`) returns the full matrix **A**, so we need to specify the argument `returnType = FALSE`, to obtain only the transition and fecundity matrices. 

```{r getFecund}
unif <- list(T = fill_transitions(TF, N, returnType = "T"), 
             F = fill_fecundity(TF, N, 
                                alpha = c(NA_real_, NA_real_, 1e-05),
                                beta = c(NA_real_, NA_real_, 1e-05),
                                returnType = "F"))
unif
```

The asymptotic population growth rate is now $\lambda =$ `r format(lambda(unif$T + unif$F),digits = 2)`. The growth rate shrinks slightly because applying the uniform prior to the transition probabilities causes the observed growth and survival transitions to shrink slightly relative to the  unobserved transitions. 


## Other options for `returnType`

There are two other `returnType`s:
1. `fill_transitions()` returns an augmented matrix of fates, which is useful for simulation. The fourth row of this result (see below) is the mortality state.   
```{r}
fill_transitions(TF, N, returnType = "TN")
```
2. `fill_fecundity()` returns the alpha and beta vectors of the posterior.  
```{r}
fill_fecundity(TF, N, 
               alpha = c(NA_real_, NA_real_, 1e-05),
               beta = c(NA_real_, NA_real_, 1e-05),
               returnType = "ab")
```

This demonstrates why the posterior point estimate of fecundity does not change much; the non-informative values for $\alpha$ and $\beta$ barely change the observed values. 

# Part II: Informative Priors

We can skip using `popbio::projection.matrix()` if the matrix is already calculated, and  we  have the stage vector. We demonstrate this using population 231 in period 2 as an example. We also  split the matrix into transition **T** and fecundity **F** matrices.

## Step 1: Load and munge the data

Get population #231 and year (period) 2 from the `L_elto` data and extract the **T** and **F** matrices. 

```{r, echo=FALSE}
# Matrix
if(!exists("L_elto")) data("L_elto")
Tmat <- L_elto %>% 
  mutate(stage = factor(stage, levels=c("p","j","a","m")),
         fate = factor(next_stage, levels=c("p","j","a","m"))) %>%
  filter(POPNUM == 231, year == 2) %>%
  as.data.frame() %>% 
  xtabs(~fate + stage, data = .) %>% 
  as.matrix()
Tmat <- Tmat[,-4] # remove the final stage, m
N <- colSums(Tmat) # get the number of individuals oer stage
Tmat <- sweep(Tmat[-4,], 2, N, "/") # what is this doing?
# L_elto %>%
#   mutate(stage = factor(stage, levels=c("p","j","a","m")),
#          fate = factor(next_stage, levels=c("p","j","a","m"))) %>%
#   filter(POPNUM == 231, year == 3, stage == "p") %>%
#   count(stage)
# 2 offspring from N[3] == 16 adults
Fmat <- matrix(0, nrow=3, ncol=3) # initialize an empty matrix (fill with zeroes)
Fmat[1,3] <- 2/16 # where dd this # come from?
(TF <- list(Tmat = Tmat, Fmat = Fmat))
```

There were `r paste(N, collapse=", ")` seedlings, juveniles, and adults, respectively, at the start of period 2 for population # 231.

## Step 2: Incorporate informative priors
This matrix is missing the rare transition from seedling to juvenile. All juveniles survived, which led to an overestimation of survival.
So, let's add a uniform dirichlet prior ???(why dirichlet? maybe a footnote with ref?)??? with weight = $1$ to the transition matrix, $T$. Here, we have 4 fates (3 + death), so each fate adds 0.25 to the matrix of *observed* fates (not the transition matrix!). When we specify a prior matrix for the transitions, there is one more row than columns. This extra row represents death.

```{r}
Tprior <- matrix(0.25, byrow = TRUE, ncol = 3, nrow=4)
fill_transitions(TF, N, P = Tprior) # returns transition matrix by default
```

We can get the same result 'by hand'

```{r}
Tobs <- sweep(TF$Tmat,2,N,"*") # get the observed transitions
Tobs <- rbind(Tobs, N - colSums(Tobs)) # add the mortality row
Tobs <- Tobs + 0.25 # add the prior
sweep(Tobs, 2, colSums(Tobs), "/")[-4,] # divide by the column sum, and discard mortality
```
???(This seems out of place?)???
The uniform prior creates problems because it provides transition values that are biologically impossible. For example, it provides a transition for adult->seedling in teh transition matrix $T$, when this transition is only possible in the fecundity matrix $F$. 
To fix this problem we specify a more informative prior (see `RLT_Tprior`). It still has to have the same shape, one more row than columns.

```{r}
RLT_Tprior <- matrix(c(0.25, 0.025, 0.0,
                       0.05, 0.9,   0.025,
                       0.01, 0.025, 0.95,
                       0.69, 0.05,  0.025), 
                     byrow = TRUE, nrow = 4, ncol = 3)
```
This prior is constructed so the columns sum to 1, which creates the greatest flexibility 
for weighting the prior.
```{r}
fill_transitions(TF, N, P = RLT_Tprior)
```
We can specify the weight as a multiple of the sample size for each stage.
```{r}
fill_transitions(TF, N, P = RLT_Tprior, priorweight = 0.5)
```
Here the prior is weighted half as much as the observed number of transitions, which is 
larger than 1 but still allows the data to dominate. 

# Part III: Obtain Credible Intervals 
## Obtain CI for indvidual matrix entries
The marginal posterior distribution of one element in a multinomial is a beta distribution, and
we use this to get credible intervals on our transition rates. We can use the 
TN return type to get the parameters of the desired multinomial.

```{r}
TN <- fill_transitions(TF, N, P = RLT_Tprior, priorweight = 0.5, returnType = "TN")
alpha <- TN[,1]
beta <- sum(TN[,1]) - TN[,1]
p <- alpha / (alpha + beta)
lcl <- qbeta(0.025, alpha, beta)
ucl <- qbeta(0.975, alpha, beta)
sprintf("%.2f (%.2f, %.2f)", p, lcl, ucl)
```

Those are the point estimates (compare with first column above), lower and upper $95\%$ credible 
intervals for transitions out of the seedling stage. There is a high degree of uncertainty because of the small sample size ($2$), and low weight on the prior ($1$), leading to an effective sample size of 3. If we increase the effective sample size to $20$ by specifying: `priorweight`$= 9 (9*2 = 18 + 2 = 20)$ the credible intervals shrink quite a bit:
???A visual for the credible intervals would be nice???
```{r}
TN <- fill_transitions(TF, N, P = RLT_Tprior, priorweight = 9, returnType = "TN")
alpha <- TN[,1]
beta <- sum(TN[,1]) - TN[,1] # beta parameter is sum of all other dirichlet parameters.
p <- alpha / (alpha + beta)
lcl <- qbeta(0.025, alpha, beta)
ucl <- qbeta(0.975, alpha, beta)
sprintf("%.2f (%.2f, %.2f)", p, lcl, ucl)
```

## Credible intervals on $\lambda$
Obtaining credible intervals on the asymptotic growth rate, $\lambda$, requires simulating matrices 
from the posterior distributions. This is somewhat complicated to do correctly, and we have written 
a function `raretrans::sim_transitions()` to generate a list of simulated matrices given the observed matrix and prior specifications.

```{r}
sim_transitions(TF, N, P = RLT_Tprior, alpha = c(NA, NA, 0.025), beta = c(NA, NA, 1),
                priorweight = 0.5)
```

Now we simulate 1000 times, calculate the leading eigenvalue of each matrix, and draw a histogram.

```{r}
set.seed(8390278) # make this part reproducible
RLT_0.5 <- sim_transitions(TF, N, P = RLT_Tprior, alpha = c(NA, NA, 0.025), beta = c(NA, NA, 1),
                priorweight = 0.5, samples = 1000)
RLT_0.5 <- tibble(lposterior = map_dbl(RLT_0.5, lambda))

ggplot(data = RLT_0.5,
       mapping = aes(x = lposterior)) + 
  geom_histogram(binwidth = 0.02)
```

We can calculate some summary statistics too.
```{r}
RLT_0.5_summary <- summarize(RLT_0.5,
                             medianL = median(lposterior),
                             meanL = mean(lposterior),
                             lcl = quantile(lposterior, probs = 0.025),
                             ucl = quantile(lposterior, probs = 0.975),
                             pincrease = sum(lposterior > 1.)/n())
knitr::kable(RLT_0.5_summary, digits = 2)
```

